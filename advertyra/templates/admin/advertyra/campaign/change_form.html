{% extends "admin/change_form.html" %}
{% load i18n %}

{% block extrahead %}
{{ block.super }}
<script id="source" type="text/javascript">
$(document).ready(function () {
    
    var choiceContainer = $("#choices");
    var datasets = '';

    $.getJSON('/advertyra/campaign/{{ object_id }}/{{ start_date|date:'m-Y' }}/ajax/', function(data){
         datasets = data;
         load(datasets);
    });

    // helper for returning the weekends in a period
    function weekendAreas(axes) {
        var markings = [];
        var d = new Date(axes.xaxis.min);
        // go to the first Saturday
        d.setUTCDate(d.getUTCDate() - ((d.getUTCDay() + 1) % 7))
        d.setUTCSeconds(0);
        d.setUTCMinutes(0);
        d.setUTCHours(0);
        var i = d.getTime();
        do {
            // when we don't set yaxis, the rectangle automatically
            // extends to infinity upwards and downwards
            markings.push({ xaxis: { from: i, to: i + 2 * 24 * 60 * 60 * 1000 } });
            i += 7 * 24 * 60 * 60 * 1000;
        } while (i < axes.xaxis.max);

        return markings;
    }
    
    function load(datasets){
       // hard-code color indices to prevent them from shifting as
       // countries are turned on/off
       var i = 0;
       $.each(datasets, function(key, val) {
           val.color = i;
           ++i;
       });
    
       // insert checkboxes 
       $.each(datasets, function(key, val) {
            choiceContainer.append('<li><input type="checkbox" name="' + key +
                                  '" checked="checked" id="id' + key + '">' +
                                  '<label for="id' + key + '">'
                                  + val.label + '</label></li>');
        });

        choiceContainer.find("input").click(function(){
            plotAccordingToChoices();
        });

        plotAccordingToChoices();
    }
    
    function plotAccordingToChoices(data, extras){
        var data = [];
        var options = {
              xaxis: { mode: "time",
              min: (new Date("{{ start_date|date:'Y/m/d' }}")).getTime(),
              max: (new Date("{{ end_date|date:'Y/m/d' }}")).getTime(),
            },
           grid: { markings: weekendAreas },
           lines: { show: true },
           points: { show: true }
        }; 
        $.extend(true, options, extras);

        choiceContainer.find("input:checked").each(function () {
            var key = $(this).attr("name");
            if (key && datasets[key])
                data.push(datasets[key]);
        });
        
        if (data.length > 0)
            $.plot($("#placeholder"), data, options);
    }

    $('select#months').change(function(){
        var url = $(this).attr("rel").replace('0', $(this).val());
        $.getJSON(url, function(data){
             var data = [];
             var start = '';
             var end = '';

             choiceContainer.find("input:checked").each(function () {
                   var key = $(this).attr("name");
                   if (key && datasets[key])
                     data.push(datasets[key]);
                     start = datasets[key].start;
                     end = datasets[key].end;
             });
        
             var options = {
                  xaxis: { mode: "time",
                  min: (new Date(start)).getTime(),
                  max: (new Date(end)).getTime(),
               },
              grid: { markings: weekendAreas },
              lines: { show: true },
              points: { show: true }
             }; 
        
             if (data.length > 0)
                $.plot($("#placeholder"), data, options);
        });
    });

});
</script>
{% endblock %}

{% block footer %}
{% if object_id %}
<div id="content" class="coIM">
  <div id="content-main">
    <form id="advertisement-form">
      <fieldset class="module aligned">
      <div class="form-row title">
        <h1>{% trans 'Clicks for' %}
        <select id="months" rel="{% url campaign_click_by_month object_id 0 %}">
          {% for month in month_list %}
          <option value="{{ month|date:'m-Y' }}">{{ month|date:'F Y' }}</option>
          <option value="01-2010">January 2010</option>
          {% endfor %}
        </select>
        </h1>
        <div id="placeholder" style="float:left;width:600px;height:300px;"></div>
        <ul id="choices" style="float:left;list-style-type:none;"></ul>
      </div>
      </fieldset>
    </form>
  </div>
</div>
{% endif %}
{% endblock %}
